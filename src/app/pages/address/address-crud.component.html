<div class="page-container">
  <mat-card>
    <div class="header">
      <h2>Ubicaciones de Entrega</h2>
      <button mat-raised-button color="primary" (click)="handleAdd()">
        <mat-icon>add</mat-icon>
        Nueva Dirección
      </button>
    </div>

    <div *ngIf="formOpen" class="form-container">
      <h3>{{ editingAddress ? 'Editar' : 'Nueva' }} Dirección</h3>
      <form [formGroup]="addressForm" (ngSubmit)="handleSubmit()">
        <mat-form-field appearance="outline">
          <mat-label>Calle</mat-label>
          <input matInput formControlName="street" required>
          <mat-error *ngIf="addressForm.get('street')?.hasError('required')">La calle es requerida</mat-error>
          <mat-error *ngIf="addressForm.get('street')?.hasError('minlength')">Mínimo 3 caracteres</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Ciudad</mat-label>
          <input matInput formControlName="city" required>
          <mat-error *ngIf="addressForm.get('city')?.hasError('required')">La ciudad es requerida</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Estado/Departamento</mat-label>
          <input matInput formControlName="state" required>
          <mat-error *ngIf="addressForm.get('state')?.hasError('required')">El estado es requerido</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Código Postal</mat-label>
          <input matInput formControlName="postal_code" required>
          <mat-error *ngIf="addressForm.get('postal_code')?.hasError('required')">El código postal es
            requerido</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Información Adicional</mat-label>
          <textarea matInput formControlName="additional_info" rows="3"></textarea>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Pedido</mat-label>
          <mat-select formControlName="order_id" required (selectionChange)="onOrderChange($event)">
            <mat-option *ngFor="let order of orders" [value]="order.id">
              Pedido #{{ getOrderIdDisplay(order.id) }} - {{ order.customer?.name || 'Cliente' }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="addressForm.get('order_id')?.hasError('required')">El pedido es requerido</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Motocicleta (para el pedido)</mat-label>
          <mat-select formControlName="motorcycle_id">
            <mat-option value="">Sin asignar</mat-option>
            <mat-option *ngFor="let motorcycle of motorcycles" [value]="motorcycle.id">
              {{ motorcycle.plate || motorcycle.license_plate }} - {{ motorcycle.brand }} {{ motorcycle.model || '' }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="form-actions">
          <button mat-button type="button" (click)="handleClose()">Cancelar</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="addressForm.invalid">
            {{ editingAddress ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </form>
    </div>

    <div class="table-container">
      <div *ngIf="addresses.length === 0" class="empty-state">
        <mat-icon>location_on</mat-icon>
        <p>No hay direcciones registradas</p>
        <button mat-raised-button color="primary" (click)="handleAdd()">
          <mat-icon>add</mat-icon>
          Crear primera dirección
        </button>
      </div>
      <table mat-table [dataSource]="addresses" class="mat-elevation-z2" *ngIf="addresses.length > 0">
        <ng-container matColumnDef="order">
          <th mat-header-cell *matHeaderCellDef>Pedido</th>
          <td mat-cell *matCellDef="let address" class="order-cell">
            <div class="order-info">
              {{ getOrderInfo(address.order_id) }}
              <button *ngIf="hasOrderWithMotorcycle(address.order_id)" mat-icon-button color="accent"
                (click)="viewOrderMap(address.order_id)" matTooltip="Ver ubicación del pedido en tiempo real"
                matTooltipPosition="above" class="map-button">
                <mat-icon>map</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="street">
          <th mat-header-cell *matHeaderCellDef>Calle</th>
          <td mat-cell *matCellDef="let address">{{ address.street }}</td>
        </ng-container>

        <ng-container matColumnDef="city">
          <th mat-header-cell *matHeaderCellDef>Ciudad</th>
          <td mat-cell *matCellDef="let address">{{ address.city }}</td>
        </ng-container>

        <ng-container matColumnDef="state">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let address">{{ address.state }}</td>
        </ng-container>

        <ng-container matColumnDef="postal_code">
          <th mat-header-cell *matHeaderCellDef>Código Postal</th>
          <td mat-cell *matCellDef="let address">{{ address.postal_code }}</td>
        </ng-container>

        <ng-container matColumnDef="motorcycle">
          <th mat-header-cell *matHeaderCellDef>Motocicleta</th>
          <td mat-cell *matCellDef="let address" class="motorcycle-cell">
            <span *ngIf="hasMotorcycle(address.order_id); else noMotorcycle" class="motorcycle-info">
              <mat-icon class="moto-icon">two_wheeler</mat-icon>
              {{ getMotorcycleInfo(address.order_id) }}
              <button *ngIf="getMotorcyclePlate(address.order_id)" mat-icon-button color="accent"
                (click)="viewMotorcycleMap(getMotorcyclePlate(address.order_id))"
                matTooltip="Ver ubicación en tiempo real" matTooltipPosition="above" class="map-button-small">
                <mat-icon>map</mat-icon>
              </button>
            </span>
            <ng-template #noMotorcycle>
              <span class="no-moto">-</span>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let address" class="actions-cell">
            <button mat-icon-button color="primary" (click)="handleEdit(address)" matTooltip="Editar dirección"
              matTooltipPosition="above">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="handleDelete(getAddressId(address.id))"
              matTooltip="Eliminar dirección" matTooltipPosition="above">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
  </mat-card>
</div>
